<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.20" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>ElasticSearch | 彼岸樱速</title><meta name="description" content="欢迎来到bays的笔记文档空间">
    <link rel="stylesheet" href="/assets/css/styles.c66d6f1b.css">
    <link rel="preload" href="/assets/js/runtime~app.e2e86f0d.js" as="script"><link rel="preload" href="/assets/css/styles.c66d6f1b.css" as="style"><link rel="preload" href="/assets/js/80.d657ec11.js" as="script"><link rel="preload" href="/assets/js/app.430f5296.js" as="script">
    <link rel="prefetch" href="/assets/js/guide_Sort.html.cc3498ab.js" as="script"><link rel="prefetch" href="/assets/js/guide_dubbo.html.e5443b69.js" as="script"><link rel="prefetch" href="/assets/js/guide_docker.html.1be59d85.js" as="script"><link rel="prefetch" href="/assets/js/guide_activeMQ.html.70fea2e2.js" as="script"><link rel="prefetch" href="/assets/js/guide_etcd.html.99df38d7.js" as="script"><link rel="prefetch" href="/assets/js/guide_excel.html.556d5808.js" as="script"><link rel="prefetch" href="/assets/js/guide_awt.html.1bfb567f.js" as="script"><link rel="prefetch" href="/assets/js/guide_git.html.f3ab9d52.js" as="script"><link rel="prefetch" href="/assets/js/guide_elasticsearch.html.1c7fe8da.js" as="script"><link rel="prefetch" href="/assets/js/guide_Arthas.html.c153b8fb.js" as="script"><link rel="prefetch" href="/assets/js/get-started.html.b5dc71a3.js" as="script"><link rel="prefetch" href="/assets/js/index.html.7a4fbc54.js" as="script"><link rel="prefetch" href="/assets/js/posts_sticky2.html.d9cac4c3.js" as="script"><link rel="prefetch" href="/assets/js/posts_archive2.html.f68e76d4.js" as="script"><link rel="prefetch" href="/assets/js/posts_archive1.html.4f0cf356.js" as="script"><link rel="prefetch" href="/assets/js/posts_article11.html.06296013.js" as="script"><link rel="prefetch" href="/assets/js/posts_article12.html.1d8d1792.js" as="script"><link rel="prefetch" href="/assets/js/posts_article10.html.5c0b3ffa.js" as="script"><link rel="prefetch" href="/assets/js/posts_article4.html.47354b73.js" as="script"><link rel="prefetch" href="/assets/js/posts_article5.html.c37516dd.js" as="script"><link rel="prefetch" href="/assets/js/posts_article6.html.93dd44a9.js" as="script"><link rel="prefetch" href="/assets/js/posts_article7.html.dcc4666e.js" as="script"><link rel="prefetch" href="/assets/js/posts_article8.html.1eb7469d.js" as="script"><link rel="prefetch" href="/assets/js/posts_article9.html.c42c4aee.js" as="script"><link rel="prefetch" href="/assets/js/posts_article3.html.39ed2ef6.js" as="script"><link rel="prefetch" href="/assets/js/posts_article1.html.4e814018.js" as="script"><link rel="prefetch" href="/assets/js/posts_article2.html.d024ac22.js" as="script"><link rel="prefetch" href="/assets/js/posts_sticky.html.3680f02b.js" as="script"><link rel="prefetch" href="/assets/js/category_category-a_index.html.52607d9f.js" as="script"><link rel="prefetch" href="/assets/js/category_category-c_index.html.512fe185.js" as="script"><link rel="prefetch" href="/assets/js/category_category-b_index.html.082a49aa.js" as="script"><link rel="prefetch" href="/assets/js/category_history_index.html.8d52ff6c.js" as="script"><link rel="prefetch" href="/assets/js/tag_tag-a_index.html.c9fbdcde.js" as="script"><link rel="prefetch" href="/assets/js/tag_tag-b_index.html.efaa4391.js" as="script"><link rel="prefetch" href="/assets/js/tag_tag-d_index.html.94a14403.js" as="script"><link rel="prefetch" href="/assets/js/tag_tag-e_index.html.848c629f.js" as="script"><link rel="prefetch" href="/assets/js/tag_tag-c_index.html.d71f5d38.js" as="script"><link rel="prefetch" href="/assets/js/category_index.html.2476444c.js" as="script"><link rel="prefetch" href="/assets/js/tag_wwii_index.html.616f6e69.js" as="script"><link rel="prefetch" href="/assets/js/tag_wwi_index.html.a7384146.js" as="script"><link rel="prefetch" href="/assets/js/404.html.73372f67.js" as="script"><link rel="prefetch" href="/assets/js/timeline_index.html.5206e93a.js" as="script"><link rel="prefetch" href="/assets/js/article_index.html.12dee35a.js" as="script"><link rel="prefetch" href="/assets/js/tag_index.html.507c41b2.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><img class="vp-site-logo" src="/logo.png" alt="彼岸樱速"><span class="vp-site-name vp-hide-mobile" aria-hidden="true">彼岸樱速</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!--[--><!--[--><!--]--><!--]-->Home<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://bianyingsu.github.io" aria-label="梦起" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><!--]--><!--]-->梦起<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/guide/activeMQ.html" aria-label="activeMQ"><!--[--><!--[--><!--]--><!--]-->activeMQ<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/article/" aria-label="Article"><!--[--><!--[--><!--]--><!--]-->Article<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/category/" aria-label="Category"><!--[--><!--[--><!--]--><!--]-->Category<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/tag/" aria-label="Tag"><!--[--><!--[--><!--]--><!--]-->Tag<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/timeline/" aria-label="Timeline"><!--[--><!--[--><!--]--><!--]-->Timeline<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!--[--><!--[--><!--]--><!--]-->Home<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://bianyingsu.github.io" aria-label="梦起" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><!--]--><!--]-->梦起<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/guide/activeMQ.html" aria-label="activeMQ"><!--[--><!--[--><!--]--><!--]-->activeMQ<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/article/" aria-label="Article"><!--[--><!--[--><!--]--><!--]-->Article<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/category/" aria-label="Category"><!--[--><!--[--><!--]--><!--]-->Category<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/tag/" aria-label="Tag"><!--[--><!--[--><!--]--><!--]-->Tag<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/timeline/" aria-label="Timeline"><!--[--><!--[--><!--]--><!--]-->Timeline<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/guide/activeMQ.html" aria-label="ActiveMQ"><!--[--><!--[--><!--]--><!--]-->ActiveMQ<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/guide/Arthas.html" aria-label="Arthas"><!--[--><!--[--><!--]--><!--]-->Arthas<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/guide/awt.html" aria-label="AWT &amp;&amp; Swing"><!--[--><!--[--><!--]--><!--]-->AWT &amp;&amp; Swing<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/guide/docker.html" aria-label="Docker"><!--[--><!--[--><!--]--><!--]-->Docker<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/guide/dubbo.html" aria-label="Dubbo"><!--[--><!--[--><!--]--><!--]-->Dubbo<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link route-link-active auto-link vp-sidebar-item vp-sidebar-heading active" href="/guide/elasticsearch.html" aria-label="ElasticSearch"><!--[--><!--[--><!--]--><!--]-->ElasticSearch<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/guide/etcd.html" aria-label="Etcd"><!--[--><!--[--><!--]--><!--]-->Etcd<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/guide/excel.html" aria-label="Excel"><!--[--><!--[--><!--]--><!--]-->Excel<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/guide/git.html" aria-label="Git"><!--[--><!--[--><!--]--><!--]-->Git<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/guide/Sort.html" aria-label="Sort"><!--[--><!--[--><!--]--><!--]-->Sort<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div><h1 id="elasticsearch" tabindex="-1"><a class="header-anchor" href="#elasticsearch"><span>ElasticSearch</span></a></h1><hr><p>aliases:</p><ul><li>elasticsearch 标题: elasticsearch</li></ul><hr><p><strong>ElasticSearch分片以及副本</strong></p><p><strong>笔记本：</strong> elasticsearch</p><p><strong>创建时间：</strong> 2023/11/10 16:08 <strong>更新时间：</strong> 2023/11/10 16:11</p><h2 id="elasticsearch分片以及副本" tabindex="-1"><a class="header-anchor" href="#elasticsearch分片以及副本"><span>ElasticSearch分片以及副本</span></a></h2><p>分片（Shard）以及副本（Replica）</p><p>分布式存储系统为了解决单机容量以及容灾的问题，都需要有分片以及副本机制。Elasticsearch</p><p>没有采用节点级别的主从复制，而是基于分片。它当前还未提供分片切分（shard-splitting）的</p><p>机制，只能创建索引的时候静态设置。</p><img src="/img/elasticsearch.pdf-0-0.png"><p>比如上图所示，开始设置为5个分片，在单个节点上，后来扩容到5个节点，每个节点有一个分</p><p>片。如果继续扩容，是不能自动切分进行数据迁移的。官方文档的说法是分片切分成本和重新索</p><p>引的成本差不多，所以建议干脆通过接口重新索引。</p><p>Elasticsearch 的分片默认是基于id 哈希的，id可以用户指定，也可以自动生成。但这个可以通</p><p>过参数（routing）或者在mapping配置中修改。当前版本默认的哈希算法是MurmurHash3。</p><p>Elasticsearch <strong>禁止同一个分片的主分片和副本分片在同一个节点上，所以如果是一个节点的集</strong></p><p><strong>群是不能有副本的。</strong></p><p><strong>为什么要考虑分片</strong></p><p>如果你刚接触ElasticSearch, 那么弄清楚它的几个术语和核心概念是非常必要的.</p><p>假设ElasticSearch集群的部署结构如下:</p><img src="/img/elasticsearch.pdf-1-0.png"><p><strong>集群(cluster)</strong> :由一个或多个节点组成, 并通过集群名称与其他集群进行区分</p><p><strong>节点(node)</strong> :单个ElasticSearch实例. 通常一个节点运行在一个隔离的容器或虚拟机中</p><p><strong>索引(index)</strong> :在ES中, 索引是一组文档的集合</p><p><strong>分片(shard)</strong> :因为ES是个分布式的搜索引擎, 所以索引通常都会分解成不同部分, 而这些分布在不同节点的数据就是分片. ES自动管理和组织分片, 并在必要的时候对分片数据进行再平衡分配,所以用户基本上不用担心分片的处理细节，一个分片默认最大文档数量是20亿.</p><p><strong>副本(replica)</strong> :ES默认为一个索引创建5个主分片, 并分别为其创建一个副本分片. 也就是说每个索引都由5个主分片成本, 而每个主分片都相应的有一个copy.对于分布式搜索引擎来说, 分片及副本的分配将是高可用及快速搜索响应的设计核心.主分片与副本都能处理查询请求, 它们的唯一区别在于只有主分片才能处理索引请求.在上图示例中, 我们的ElasticSearch集群有两个节点, 并使用了默认的分片配置. ES自动把这5个主分片分配到2个节点上, 而它们分别对应的副本则在完全不同的节点上. 对,就这是分布式的概念.</p><p><strong>副本作用</strong></p><p>副本分片的主要目的就是 <strong>为了故障转移以及实现负载均衡</strong> ，正如在 集群内的原理 中讨论的：如果持有主分片的节点挂掉了，一个副本分片就会晋升为主分片的角色。在索引写入时，副本分片做着与主分片相同的工作。新文档首先被索引进主分片然后再同步到其它所有的副本分片。增加副本数并不会增加索引容量。无论如何，副本分片可以服务于读请求，如果你的索引也如常见的那样是偏向查询使用的，那你可以通过增加副本的数目来提升查询性能，但也要为此 增加额外的硬件资源。搜索性能取决于最慢的节点的响应时间，所以尝试均衡所有节点的负载是一个好想法。 如果我们只是增加一个节点而不是两个，最终我们会有两个节点各持有一个分片，而另一个持有两个分片做着两倍的工作。</p><h2 id="倒排索引原理" tabindex="-1"><a class="header-anchor" href="#倒排索引原理"><span><strong>倒排索引原理</strong></span></a></h2><p><strong>笔记本：</strong> elasticsearch</p><p><strong>创建时间：</strong> 2023/11/10 15:58 <strong>更新时间：</strong> 2023/11/10 16:01</p><h3 id="分布式搜索引擎elasticsearch之-倒排索引原理" tabindex="-1"><a class="header-anchor" href="#分布式搜索引擎elasticsearch之-倒排索引原理"><span><strong>分布式搜索引擎ElasticSearch之 倒排索引原理</strong></span></a></h3><p><strong>倒排索引原理</strong></p><p>ES采用的是倒排索引（Inverted Index）, 也称为反向索引。 有反向索引，也会有正向索</p><p><strong>1. 正向索引</strong></p><p>正排索引是以文档的ID作为关键字，并且记录文档中每个字段的值信息，通过查询id来把</p><p>拿出来。</p><p>但是在查询某一个keyword存在于哪些文档的时候， 需要对所有文档进行扫描匹配。这</p><p>率比较低下。</p><img src="/img/elasticsearch.pdf-3-0.png"><p><strong>2. 倒排索引</strong></p><p>倒排索引以字或词作为关键字索引， 倒排索引建立的是分词（Term）和文档（Document）之间的映射关系。</p><img src="/img/elasticsearch.pdf-3-1.png"><p>倒排索引表结构， 去除停用词后构造的倒排索引：</p><p>倒排索引主要由单词词典（Term Dictionary）和倒排列表（Posting List）及倒排文件(Inverted File)组成。</p><img src="/img/elasticsearch.pdf-4-0.png"><p><strong>单词词典（Term Dictionary）：</strong> 搜索引擎的通常索引单位是单词，单词词典是由文档集合中出现过的所有单词构成的字符串集合。 **倒排列表(PostingList)：**倒排列表记载了出现过某个单词的所有文档的文档列表，以及单词在该文档中出现的位置信息及频率，每条记录称为一个倒排项(Posting)。 **倒排文件(Inverted File)：**所有单词的倒排列表按顺序地存储在磁盘的某个文件里，这个文件即被称之为倒排文件，倒排文件是存储倒排索引的物理文件。</p><p><strong>3. 如何定位</strong></p><p>对于规模很大的文档集合，里面可能包含上百万的关键单词（term）, 找出某个特定的te</p><p>慢， 需要逐个过滤一遍，如何快速定位？</p><p>先做好排序，然后用二分查找的方式，这样比全部遍历方式来得更快，这个就是term</p><p>dictionary。可以采用logN次磁盘查找获取目标，但是磁盘随机读操作仍然非常昂贵（一</p><p>读random access 大概需10ms），</p><p>所以尽量少读磁盘， 但缓存到内存中， 整个term dictionary又非常大， 于是就有了ter</p><p>字典的索引。</p><p>term index 是b-tree结构：</p><img src="/img/elasticsearch.pdf-4-1.png"><p>这棵树不会包含所有的term，它只记录term的一些前缀。通过term index可以快速地定位到term dictionary的某个offset，然后从这个位置再往后顺序查找。</p><img src="/img/elasticsearch.pdf-5-0.png"><p>所以term index不需要存储所有的term，而仅仅是他们的一些前缀与Term Dictionary的block之间的映射关系，再结合FST(Finite State Transducers)的压缩技术，可以使term index缓存到内存中。从term index查到对应的term dictionary的block位置之后，再去磁盘上找term，大大减少了磁盘随机读的次数。</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">最近更新：: </span><time class="meta-item-info" datetime="2026-01-08T09:29:01.000Z" data-allow-mismatch>2026/1/8 09:29</time></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: wuyuying@foresee.com.cn">wuyuying</span><!----><!--]--><!--]--></span></div></div></footer><nav class="vp-page-nav" aria-label="page navigation"><a class="route-link auto-link prev" href="/guide/dubbo.html" aria-label="Dubbo"><!--[--><div class="hint"><span class="arrow left"></span> Prev</div><div class="link"><span class="external-link">Dubbo</span></div><!--]--></a><a class="route-link auto-link next" href="/guide/etcd.html" aria-label="Etcd"><!--[--><div class="hint">Next <span class="arrow right"></span></div><div class="link"><span class="external-link">Etcd</span></div><!--]--></a></nav><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script src="/assets/js/runtime~app.e2e86f0d.js" defer></script><script src="/assets/js/80.d657ec11.js" defer></script><script src="/assets/js/app.430f5296.js" defer></script>
  </body>
</html>
